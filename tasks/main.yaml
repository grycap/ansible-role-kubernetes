---
- name: Disable swap
  command: swapoff -a

- name: Disable SWAP in fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s+sw.*)$'
    replace: '# \1'

- name: Check kube version
  shell: kubeadm version -o short | cut -d 'v' -f 2
  register: kubeadm_output
  changed_when: false

- debug: msg="Kube version installed = {{ kubeadm_output.stdout }}"

- block:

  - name: Create /etc/modules-load.d/containerd.conf
    register: containerd_json
    copy:
      content: |
        overlay
        br_netfilter
      dest: /etc/modules-load.d/containerd.conf

  - name: Make modprobes
    command: modprobe {{item}}
    with_items:
      - overlay
      - br_netfilter
    when: containerd_json is changed

  - name: Create /etc/sysctl.d/99-kubernetes-cri.conf
    register: containerd_sysctl
    copy:
      content: |
        net.bridge.bridge-nf-call-iptables  = 1
        net.ipv4.ip_forward                 = 1
        net.bridge.bridge-nf-call-ip6tables = 1
      dest: /etc/sysctl.d/99-kubernetes-cri.conf

  - name: Apply sysctl params
    command: sysctl --system
    when: containerd_sysctl is changed

  when: kube_cri_runtime == "containerd"

- name: Include "{{ansible_os_family}}" Kubernetes recipe
  include_tasks: "{{ansible_os_family}}.yaml"

- name: Add KUBELET_EXTRA_ARGS
  lineinfile:
    dest: "{{item}}/kubelet"
    line: 'KUBELET_EXTRA_ARGS=--cgroup-driver=systemd {{kubelet_extra_args}}'
    regexp: 'KUBELET_EXTRA_ARGS='
    create: yes
  notify: restart kubelet
  with_first_found:
    - files:
       - /etc/sysconfig/
       - /etc/default/

- name: Include "{{kube_type_of_node}}" tasks
  include_tasks: "{{kube_type_of_node}}.yaml"
  when: kube_type_of_node == "front" or kube_type_of_node == "wn"

- name: Include control_plane tasks
  include_tasks: "wn.yaml"
  when: kube_type_of_node == "control_plane"